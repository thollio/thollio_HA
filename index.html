<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå≤ Thollio Holzerfassung</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #1f2937; color: #f9fafb; font-size: 1.1rem; }
    input, select, button { font-size: 1.1rem; }
    input, select { padding: 0.7rem; }
    table { width: 100%; border-collapse: collapse; cursor: pointer; }
    th, td { padding: 0.6rem; border: 1px solid #374151; text-align: center; }
    th { background-color: #111827; }
    td { background-color: #1f2937; }
    tr:hover { background-color: #374151; }
    button { cursor: pointer; padding: 0.7rem 1.2rem; border-radius: 0.5rem; font-weight: 600; }
    #map { height: 340px; border-radius: 1rem; overflow: hidden; margin-top: 1rem; }
    @media (max-width: 768px) {
      input, select, button { width: 100%; font-size: 1.2rem; }
      .grid { gap: 0.75rem; }
      h1 { font-size: 1.8rem; }
      #map { height: 280px; }
    }
  </style>
</head>
<body class="p-4 md:p-6">
  <h1 class="text-3xl font-bold mb-3 text-center">üå≤ Thollio Holzerfassung</h1>

  <div class="flex justify-center mb-6">
    <a href="https://thollio.github.io/thollio_HA_MA/" target="_blank"
       class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md">
      Hier geht es zur Holzmantelmessung
    </a>
  </div>

  <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <input id="stammnummer" placeholder="Stammnummer (optional)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="polternummer" placeholder="Polternummer" class="p-2 rounded bg-gray-700" />
    <input id="hiebnummer" placeholder="Hiebnummer" class="p-2 rounded bg-gray-700" />
    <input id="losnummer" placeholder="Losnummer" class="p-2 rounded bg-gray-700" />

    <div>
      <select id="baumart" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- Baumart w√§hlen --</option>
        <option value="Fichte">Fichte</option>
        <option value="Wei√ütanne">Wei√ütanne</option>
        <option value="Douglasie">Douglasie</option>
        <option value="L√§rche">L√§rche</option>
        <option value="Kiefer">Kiefer</option>
        <option value="Buche">Buche</option>
        <option value="Eiche">Eiche</option>
        <option value="Ahorn">Ahorn</option>
        <option value="Birke">Birke</option>
        <option value="Kirsche">Kirsche</option>
        <option value="Erle">Erle</option>
        <option value="LBH">LBH</option>
        <option value="LBW">LBW</option>
        <option value="Andere">Andere...</option>
      </select>
      <input id="baumartAnders" placeholder="Baumart eingeben" class="p-2 rounded bg-gray-700 mt-2 hidden w-full" />
    </div>

    <div>
      <select id="guete" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- G√ºteklasse --</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="BC">BC</option>
        <option value="CK">CK</option>
        <option value="N">N</option>
        <option value="K">K</option>
      </select>
    </div>

    <input id="laenge" placeholder="L√§nge (m)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="durchmesser" placeholder="Durchmesser (cm)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="datum" type="date" class="p-2 rounded bg-gray-700" />
    <input id="bemerkung" placeholder="Bemerkung" class="p-2 rounded bg-gray-700" />
  </div>

  <div id="map" class="shadow-lg"></div>

  <div class="mt-4 flex flex-wrap gap-2">
    <button id="hinzufuegen" class="bg-green-600 hover:bg-green-700">Eintrag hinzuf√ºgen</button>
    <button id="aktualisieren" class="bg-yellow-600 hidden">Eintrag aktualisieren</button>
    <button id="exportCSV" class="bg-blue-600 hover:bg-blue-700">CSV exportieren</button>
    <button id="exportExcel" class="bg-amber-500 hover:bg-amber-600">Excel exportieren</button>
    <button id="loeschen" class="bg-red-600 hover:bg-red-700">Alles l√∂schen</button>
  </div>

  <table class="mt-5 text-sm md:text-base">
    <thead>
      <tr>
        <th>Stammnr.</th>
        <th>Polternr.</th>
        <th>Hiebnr.</th>
        <th>Losnr.</th>
        <th>Baumart</th>
        <th>G√ºte</th>
        <th>L√§nge (m)</th>
        <th>Durchm. (cm)</th>
        <th>Volumen (m¬≥)</th>
        <th>Datum</th>
        <th>Standort</th>
        <th>Bemerkung</th>
        <th>üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody id="tabelle"></tbody>
    <tfoot>
      <tr class="font-bold bg-gray-800">
        <td colspan="8" class="text-right pr-4">Gesamtvolumen:</td>
        <td id="gesamtVolumen">0.000</td>
        <td colspan="4"></td>
      </tr>
    </tfoot>
  </table>

  <script>
    let daten = [];
    let map, marker, editIndex = null, lastEntry = null, currentCoords = null;

    const stammnummer = document.getElementById('stammnummer');
    const polternummer = document.getElementById('polternummer');
    const hiebnummer = document.getElementById('hiebnummer');
    const losnummer = document.getElementById('losnummer');
    const baumart = document.getElementById('baumart');
    const baumartAnders = document.getElementById('baumartAnders');
    const guete = document.getElementById('guete');
    const laenge = document.getElementById('laenge');
    const durchmesser = document.getElementById('durchmesser');
    const datum = document.getElementById('datum');
    const bemerkung = document.getElementById('bemerkung');
    const tabelle = document.getElementById('tabelle');
    const gesamtVolumenEl = document.getElementById('gesamtVolumen');
    const btnAdd = document.getElementById('hinzufuegen');
    const btnUpdate = document.getElementById('aktualisieren');

    // --- Aktuelles Datum als Standardwert ---
    window.addEventListener('load', () => {
      const heute = new Date();
      datum.value = heute.toISOString().split('T')[0];
      initMap();
    });

    // --- OpenStreetMap ---
    function initMap() {
      map = L.map('map').setView([51.1657, 10.4515], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          currentCoords = [latitude, longitude];
          setMarker(latitude, longitude);
          map.setView([latitude, longitude], 15);
        });
      }

      map.on('click', e => setMarker(e.latlng.lat, e.latlng.lng));
    }

    function setMarker(lat, lng) {
      currentCoords = [lat, lng];
      if (marker) marker.setLatLng([lat, lng]);
      else {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const pos = marker.getLatLng();
          currentCoords = [pos.lat, pos.lng];
        });
      }
    }

    // --- Logik ---
    function volumenBerechnen(d, l) {
      const dd = parseFloat(d), ll = parseFloat(l);
      return ((Math.PI * Math.pow(dd / 2, 2) * ll) / 10000).toFixed(3);
    }

    function render() {
      tabelle.innerHTML = '';
      let summe = 0;
      daten.forEach((e, i) => {
        summe += parseFloat(e.volumen);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.stammnummer || ''}</td>
          <td>${e.polternummer}</td>
          <td>${e.hiebnummer}</td>
          <td>${e.losnummer}</td>
          <td>${e.baumart}</td>
          <td>${e.guete}</td>
          <td>${e.laenge}</td>
          <td>${e.durchmesser}</td>
          <td>${e.volumen}</td>
          <td>${e.datum}</td>
          <td>${e.standort}</td>
          <td>${e.bemerkung}</td>
          <td><button class='bg-red-600 px-2 py-1 rounded' onclick='loeschenEintrag(${i})'>üóëÔ∏è</button></td>
        `;
        tr.addEventListener('click', () => ladeZumBearbeiten(i));
        tabelle.appendChild(tr);
      });
      gesamtVolumenEl.textContent = summe.toFixed(3);
    }

    window.loeschenEintrag = i => { daten.splice(i, 1); render(); };

    function ladeZumBearbeiten(i) {
      const e = daten[i];
      Object.entries(e).forEach(([k,v]) => {
        if (document.getElementById(k)) document.getElementById(k).value = v;
      });
      if (e.standort.includes(',')) {
        const [lat, lon] = e.standort.split(',').map(parseFloat);
        setMarker(lat, lon);
      }
      editIndex = i;
      btnAdd.classList.add('hidden');
      btnUpdate.classList.remove('hidden');
    }

    btnUpdate.addEventListener('click', () => {
      const e = daten[editIndex];
      Object.assign(e, erfasseEingabe());
      render();
      editIndex = null;
      btnUpdate.classList.add('hidden');
      btnAdd.classList.remove('hidden');
    });

    function erfasseEingabe() {
      return {
        stammnummer: stammnummer.value,
        polternummer: polternummer.value,
        hiebnummer: hiebnummer.value,
        losnummer: losnummer.value,
        baumart: baumart.value === 'Andere' ? baumartAnders.value : baumart.value,
        guete: guete.value,
        laenge: laenge.value,
        durchmesser: durchmesser.value,
        datum: datum.value,
        standort: currentCoords ? `${currentCoords[0].toFixed(6)}, ${currentCoords[1].toFixed(6)}` : '',
        bemerkung: bemerkung.value,
        volumen: volumenBerechnen(durchmesser.value, laenge.value)
      };
    }

    btnAdd.addEventListener('click', () => {
      const e = erfasseEingabe();
      if (!e.guete || !e.baumart || !e.laenge || !e.durchmesser) return;
      daten.push(e);
      lastEntry = e;
      render();

      // Stammnummer automatisch +1 erh√∂hen
      if (e.stammnummer) stammnummer.value = parseInt(e.stammnummer) + 1;

      // N√§chster Eintrag vorbereitet
      laenge.focus();
      laenge.select();
    });

    // --- Enter-Steuerung ---
    laenge.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        durchmesser.focus();
        durchmesser.select();
      }
    });
    durchmesser.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnAdd.click();
      }
    });

    document.getElementById('exportCSV').addEventListener('click', () => {
      const header = ['Stammnummer','Polternummer','Hiebnummer','Losnummer','Baumart','G√ºteklasse','L√§nge','Durchmesser','Volumen','Datum','Standort','Bemerkung'];
      const rows = daten.map(e => [e.stammnummer,e.polternummer,e.hiebnummer,e.losnummer,e.baumart,e.guete,e.laenge,e.durchmesser,e.volumen,e.datum,e.standort,e.bemerkung].join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'thollio_holzerfassung.csv';
      a.click();
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(daten);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Thollio_Holzerfassung');
      XLSX.writeFile(wb, 'thollio_holzerfassung.xlsx');
    });

    document.getElementById('loeschen').addEventListener('click', () => { daten = []; render(); });
  </script>
</body>
</html>
