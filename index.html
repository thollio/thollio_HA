<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå≤ Thollio Holzerfassung</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #1f2937; color: #f9fafb; }
    input, select, button { font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; cursor: pointer; }
    th, td { padding: 0.5rem; border: 1px solid #374151; text-align: center; }
    th { background-color: #111827; }
    td { background-color: #1f2937; }
    tr:hover { background-color: #374151; }
    button { cursor: pointer; }
    #map { height: 320px; border-radius: 1rem; overflow: hidden; margin-top: 1rem; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-2">üå≤ Thollio Holzerfassung</h1>

  <!-- Neuer Button -->
  <a href="https://thollio.github.io/thollio_HA_MA/" target="_blank"
     class="inline-block mb-6 px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition">
    Hier geht es zur Holzmantelmessung
  </a>

  <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Polternummer -->
    <input id="polternummer" placeholder="Polternummer" class="p-2 rounded bg-gray-700" />
    <!-- Hiebnummer -->
    <input id="hiebnummer" placeholder="Hiebnummer" class="p-2 rounded bg-gray-700" />
    <!-- Losnummer -->
    <input id="losnummer" placeholder="Losnummer" class="p-2 rounded bg-gray-700" />
    <!-- Stammnummer -->
    <input id="stammnummer" placeholder="Stammnummer (optional)" type="number" class="p-2 rounded bg-gray-700" />

    <!-- Baumart -->
    <div>
      <select id="baumart" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- Baumart w√§hlen --</option>
        <option value="Fichte">Fichte</option>
        <option value="Wei√ütanne">Wei√ütanne</option>
        <option value="Douglasie">Douglasie</option>
        <option value="L√§rche">L√§rche</option>
        <option value="Kiefer">Kiefer</option>
        <option value="Buche">Buche</option>
        <option value="Eiche">Eiche</option>
        <option value="Ahorn">Ahorn</option>
        <option value="Birke">Birke</option>
        <option value="Kirsche">Kirsche</option>
        <option value="Erle">Erle</option>
        <option value="LBH">LBH</option>
        <option value="LBW">LBW</option>
        <option value="Andere">Andere...</option>
      </select>
      <input id="baumartAnders" placeholder="Baumart eingeben" class="p-2 rounded bg-gray-700 mt-2 hidden w-full" />
    </div>

    <!-- G√ºteklasse -->
    <div>
      <select id="guete" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- G√ºteklasse --</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="BC">BC</option>
        <option value="CK">CK</option>
        <option value="N">N</option>
        <option value="K">K</option>
      </select>
    </div>

    <input id="laenge" placeholder="L√§nge (m)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="durchmesser" placeholder="Durchmesser (cm)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="datum" type="date" class="p-2 rounded bg-gray-700" />

    <input id="bemerkung" placeholder="Bemerkung" class="p-2 rounded bg-gray-700" />
  </div>

  <div id="map" class="shadow-lg"></div>

  <div class="mt-4 space-x-2">
    <button id="hinzufuegen" class="px-4 py-2 bg-green-600 rounded">Eintrag hinzuf√ºgen</button>
    <button id="aktualisieren" class="px-4 py-2 bg-yellow-600 rounded hidden">Eintrag aktualisieren</button>
    <button id="exportCSV" class="px-4 py-2 bg-blue-600 rounded">CSV exportieren</button>
    <button id="exportExcel" class="px-4 py-2 bg-amber-500 rounded">Excel exportieren</button>
    <button id="loeschen" class="px-4 py-2 bg-red-600 rounded">Alles l√∂schen</button>
  </div>

  <table class="mt-4">
    <thead>
      <tr>
        <th>Polternr.</th>
        <th>Hiebnr.</th>
        <th>Losnr.</th>
        <th>Stammnr.</th>
        <th>Baumart</th>
        <th>G√ºteklasse</th>
        <th>L√§nge (m)</th>
        <th>Durchmesser (cm)</th>
        <th>Volumen (m¬≥)</th>
        <th>Datum</th>
        <th>Standort</th>
        <th>Bemerkung</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="tabelle"></tbody>
    <tfoot>
      <tr class="font-bold bg-gray-800">
        <td colspan="8" class="text-right pr-4">Gesamtvolumen:</td>
        <td id="gesamtVolumen">0.000</td>
        <td colspan="4"></td>
      </tr>
    </tfoot>
  </table>

  <script>
    let daten = [];
    let map, marker, editIndex = null, lastEntry = null;

    const polternummer = document.getElementById('polternummer');
    const hiebnummer = document.getElementById('hiebnummer');
    const losnummer = document.getElementById('losnummer');
    const stammnummer = document.getElementById('stammnummer');
    const baumart = document.getElementById('baumart');
    const baumartAnders = document.getElementById('baumartAnders');
    const guete = document.getElementById('guete');
    const laenge = document.getElementById('laenge');
    const durchmesser = document.getElementById('durchmesser');
    const datum = document.getElementById('datum');
    const bemerkung = document.getElementById('bemerkung');
    const tabelle = document.getElementById('tabelle');
    const gesamtVolumenEl = document.getElementById('gesamtVolumen');
    const btnAdd = document.getElementById('hinzufuegen');
    const btnUpdate = document.getElementById('aktualisieren');

    // üó∫Ô∏è Karte initialisieren (GitHub-kompatibel, keine API n√∂tig)
    function initMap() {
      map = L.map('map').setView([51.1657, 10.4515], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          setMarker(lat, lon);
        });
      }

      map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        setMarker(lat, lng);
      });
    }

    function setMarker(lat, lng) {
      if (marker) marker.setLatLng([lat, lng]);
      else {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const pos = marker.getLatLng();
          marker.bindPopup(`üìç ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`).openPopup();
        });
      }
      map.setView([lat, lng], 15);
      marker.bindPopup(`üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
    }

    baumart.addEventListener('change', () => {
      baumartAnders.classList.toggle('hidden', baumart.value !== 'Andere');
    });

    function volumenBerechnen(d, l) {
      const dd = parseFloat(d), ll = parseFloat(l);
      return ((Math.PI * Math.pow(dd / 2, 2) * ll) / 10000).toFixed(3);
    }

    function render() {
      tabelle.innerHTML = '';
      let summe = 0;
      daten.forEach((e, i) => {
        summe += parseFloat(e.volumen);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.polternummer}</td>
          <td>${e.hiebnummer}</td>
          <td>${e.losnummer}</td>
          <td>${e.stammnummer || ''}</td>
          <td>${e.baumart}</td>
          <td>${e.guete}</td>
          <td>${e.laenge}</td>
          <td>${e.durchmesser}</td>
          <td>${e.volumen}</td>
          <td>${e.datum}</td>
          <td>${marker ? marker.getLatLng().lat.toFixed(6)+", "+marker.getLatLng().lng.toFixed(6) : ""}</td>
          <td>${e.bemerkung}</td>
          <td><button class='bg-red-600 px-2 py-1 rounded' onclick='loeschenEintrag(${i})'>üóëÔ∏è</button></td>
        `;
        tr.addEventListener('click', () => ladeZumBearbeiten(i));
        tabelle.appendChild(tr);
      });
      gesamtVolumenEl.textContent = summe.toFixed(3);
    }

    window.loeschenEintrag = (i) => { daten.splice(i, 1); render(); };

    function eintragSpeichern() {
      let b = baumart.value === 'Andere' ? baumartAnders.value : baumart.value;
      if (!b || !guete.value || !laenge.value || !durchmesser.value) return;

      const pos = marker ? marker.getLatLng() : { lat: 0, lng: 0 };
      const eintrag = {
        polternummer: polternummer.value,
        hiebnummer: hiebnummer.value,
        losnummer: losnummer.value,
        stammnummer: stammnummer.value,
        baumart: b,
        guete: guete.value,
        laenge: laenge.value,
        durchmesser: durchmesser.value,
        datum: datum.value,
        standort: `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`,
        bemerkung: bemerkung.value,
        volumen: volumenBerechnen(durchmesser.value, laenge.value)
      };

      daten.push(eintrag);
      render();
      lastEntry = eintrag;

      // Automatische Stammnummer-Erh√∂hung
      if (stammnummer.value) stammnummer.value = parseInt(stammnummer.value) + 1;

      durchmesser.focus();
    }

    btnAdd.addEventListener('click', eintragSpeichern);

    // Enter-Taste aktiviert nur in Durchmesser oder Bemerkung das Speichern
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (document.activeElement.id === 'durchmesser' || document.activeElement.id === 'bemerkung')) {
        e.preventDefault();
        eintragSpeichern();
      }
    });

    document.getElementById('exportCSV').addEventListener('click', () => {
      const header = ['Polternummer','Hiebnummer','Losnummer','Stammnummer','Baumart','G√ºteklasse','L√§nge','Durchmesser','Volumen','Datum','Standort','Bemerkung'];
      const rows = daten.map(e => [e.polternummer,e.hiebnummer,e.losnummer,e.stammnummer,e.baumart,e.guete,e.laenge,e.durchmesser,e.volumen,e.datum,e.standort,e.bemerkung].join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'thollio_holzerfassung.csv';
      a.click();
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(daten);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Thollio_Holzerfassung');
      XLSX.writeFile(wb, 'thollio_holzerfassung.xlsx');
    });

    document.getElementById('loeschen').addEventListener('click', () => {
      daten = [];
      render();
    });

    window.addEventListener('load', () => {
      initMap();
      durchmesser.focus();
    });
  </script>
</body>
</html>
