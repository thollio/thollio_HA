<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå≤ Thollio Holzerfassung </title>

  <script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { background-color: #1f2937; color: #f9fafb; }
    input, select, button { font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; cursor: pointer; }
    th, td { padding: 0.5rem; border: 1px solid #374151; text-align: center; }
    th { background-color: #111827; }
    td { background-color: #1f2937; }
    tr:hover { background-color: #374151; }
    button { cursor: pointer; }
    #map { height: 320px; border-radius: 1rem; overflow: hidden; margin-top: 1rem; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-4">üå≤ Holzerfassung Offline</h1>

  <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Baumart -->
    <div>
      <select id="baumart" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- Baumart w√§hlen --</option>
        <option value="Fichte">Fichte</option>
        <option value="Wei√ütanne">Wei√ütanne</option>
        <option value="Douglasie">Douglasie</option>
        <option value="L√§rche">L√§rche</option>
        <option value="Kiefer">Kiefer</option>
        <option value="Buche">Buche</option>
        <option value="Eiche">Eiche</option>
        <option value="Ahorn">Ahorn</option>
        <option value="Birke">Birke</option>
        <option value="Kirsche">Kirsche</option>
        <option value="Erle">Erle</option>
        <option value="LBH">LBH</option>
        <option value="LBW">LBW</option>
        <option value="Andere">Andere...</option>
      </select>
      <input id="baumartAnders" placeholder="Baumart eingeben" class="p-2 rounded bg-gray-700 mt-2 hidden w-full" />
    </div>

    <!-- G√ºteklasse -->
    <div>
      <select id="guete" class="p-2 rounded bg-gray-700 w-full">
        <option value="">-- G√ºteklasse --</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="BC">BC</option>
        <option value="CK">CK</option>
        <option value="N">N</option>
        <option value="K">K</option>
      </select>
    </div>

    <input id="laenge" placeholder="L√§nge (m)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="durchmesser" placeholder="Durchmesser (cm)" type="number" class="p-2 rounded bg-gray-700" />
    <input id="datum" type="date" class="p-2 rounded bg-gray-700" />

    <!-- Standort -->
    <div class="flex space-x-2">
      <input id="standort" placeholder="Standort oder Koordinaten" class="p-2 rounded bg-gray-700 flex-grow" />
      <button id="getLocation" class="px-3 bg-indigo-600 rounded">üìç</button>
    </div>

    <input id="bemerkung" placeholder="Bemerkung" class="p-2 rounded bg-gray-700" />
  </div>

  <!-- Karte -->
  <div id="map" class="shadow-lg"></div>

  <div class="mt-4 space-x-2">
    <button id="hinzufuegen" class="px-4 py-2 bg-green-600 rounded">Eintrag hinzuf√ºgen</button>
    <button id="aktualisieren" class="px-4 py-2 bg-yellow-600 rounded hidden">Eintrag aktualisieren</button>
    <button id="exportCSV" class="px-4 py-2 bg-blue-600 rounded">CSV exportieren</button>
    <button id="exportExcel" class="px-4 py-2 bg-amber-500 rounded">Excel exportieren</button>
    <button id="loeschen" class="px-4 py-2 bg-red-600 rounded">Alles l√∂schen</button>
  </div>

  <table class="mt-4">
    <thead>
      <tr>
        <th>Baumart</th>
        <th>G√ºteklasse</th>
        <th>L√§nge (m)</th>
        <th>Durchmesser (cm)</th>
        <th>Volumen (m¬≥)</th>
        <th>Datum</th>
        <th>Standort</th>
        <th>Bemerkung</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="tabelle"></tbody>
    <tfoot>
      <tr class="font-bold bg-gray-800">
        <td colspan="4" class="text-right pr-4">Gesamtvolumen:</td>
        <td id="gesamtVolumen">0.000</td>
        <td colspan="4"></td>
      </tr>
    </tfoot>
  </table>

  <script>
    let daten = [];
    let map, marker, editIndex = null, lastEntry = null;

    const baumart = document.getElementById('baumart');
    const baumartAnders = document.getElementById('baumartAnders');
    const guete = document.getElementById('guete');
    const laenge = document.getElementById('laenge');
    const durchmesser = document.getElementById('durchmesser');
    const datum = document.getElementById('datum');
    const standort = document.getElementById('standort');
    const bemerkung = document.getElementById('bemerkung');
    const tabelle = document.getElementById('tabelle');
    const gesamtVolumenEl = document.getElementById('gesamtVolumen');
    const btnAdd = document.getElementById('hinzufuegen');
    const btnUpdate = document.getElementById('aktualisieren');

    function initMap() {
      map = L.map('map').setView([51.1657, 10.4515], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        setMarker(lat, lng);
      });
    }

    function setMarker(lat, lng) {
      standort.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      if (marker) marker.setLatLng([lat, lng]);
      else {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const pos = marker.getLatLng();
          standort.value = `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
        });
      }
      map.setView([lat, lng], 15);
    }

    function getGPS() {
      if (!navigator.geolocation) return alert("GPS nicht unterst√ºtzt");
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        setMarker(lat, lon);
      });
    }

    document.getElementById('getLocation').addEventListener('click', getGPS);

    baumart.addEventListener('change', () => {
      baumartAnders.classList.toggle('hidden', baumart.value !== 'Andere');
    });

    function volumenBerechnen(d, l) {
      const dd = parseFloat(d), ll = parseFloat(l);
      return ((Math.PI * Math.pow(dd / 2, 2) * ll) / 10000).toFixed(3);
    }

    function render() {
      tabelle.innerHTML = '';
      let summe = 0;
      daten.forEach((e, i) => {
        summe += parseFloat(e.volumen);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.baumart}</td>
          <td>${e.guete}</td>
          <td>${e.laenge}</td>
          <td>${e.durchmesser}</td>
          <td>${e.volumen}</td>
          <td>${e.datum}</td>
          <td>${e.standort}</td>
          <td>${e.bemerkung}</td>
          <td><button class='bg-red-600 px-2 py-1 rounded' onclick='loeschenEintrag(${i})'>üóëÔ∏è</button></td>
        `;
        tr.addEventListener('click', () => ladeZumBearbeiten(i));
        tabelle.appendChild(tr);
      });
      gesamtVolumenEl.textContent = summe.toFixed(3);
    }

    window.loeschenEintrag = (i) => { daten.splice(i, 1); render(); };

    function ladeZumBearbeiten(i) {
      const e = daten[i];
      baumart.value = e.baumart;
      guete.value = e.guete;
      laenge.value = e.laenge;
      durchmesser.value = e.durchmesser;
      datum.value = e.datum;
      standort.value = e.standort;
      bemerkung.value = e.bemerkung;

      if (e.standort.includes(',')) {
        const [lat, lon] = e.standort.split(',').map(parseFloat);
        setMarker(lat, lon);
      }

      editIndex = i;
      btnAdd.classList.add('hidden');
      btnUpdate.classList.remove('hidden');
    }

    btnUpdate.addEventListener('click', () => {
      const e = daten[editIndex];
      e.baumart = baumart.value;
      e.guete = guete.value;
      e.laenge = laenge.value;
      e.durchmesser = durchmesser.value;
      e.datum = datum.value;
      e.standort = standort.value;
      e.bemerkung = bemerkung.value;
      e.volumen = volumenBerechnen(e.durchmesser, e.laenge);
      render();
      editIndex = null;
      btnUpdate.classList.add('hidden');
      btnAdd.classList.remove('hidden');
    });

    btnAdd.addEventListener('click', () => {
      let b = baumart.value === 'Andere' ? baumartAnders.value : baumart.value;
      if (!b || !guete.value || !laenge.value || !durchmesser.value) return;

      const eintrag = {
        baumart: b,
        guete: guete.value,
        laenge: laenge.value,
        durchmesser: durchmesser.value,
        datum: datum.value,
        standort: standort.value,
        bemerkung: bemerkung.value,
        volumen: volumenBerechnen(durchmesser.value, laenge.value)
      };
      daten.push(eintrag);
      lastEntry = eintrag;
      render();

      // Felder mit letztem Eintrag vorausf√ºllen
      baumart.value = eintrag.baumart;
      guete.value = eintrag.guete;
      laenge.value = eintrag.laenge;
      durchmesser.value = eintrag.durchmesser;
      datum.value = eintrag.datum;
      bemerkung.value = eintrag.bemerkung;
    });

    document.getElementById('exportCSV').addEventListener('click', () => {
      const header = ['Baumart','G√ºteklasse','L√§nge','Durchmesser','Volumen','Datum','Standort','Bemerkung'];
      const rows = daten.map(e => [e.baumart,e.guete,e.laenge,e.durchmesser,e.volumen,e.datum,e.standort,e.bemerkung].join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'holzerfassung.csv';
      a.click();
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(daten);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Holzerfassung');
      XLSX.writeFile(wb, 'holzerfassung.xlsx');
    });

    document.getElementById('loeschen').addEventListener('click', () => {
      daten = [];
      render();
    });

    window.addEventListener('load', initMap);
  </script>
</body>
</html>

